
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://datashades.github.io/ckanext-files/implementation-example/">
      
      
        <link rel="prev" href="../upload-strategies/">
      
      
        <link rel="next" href="../shared/">
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>Example implementation of custom storage adapter - ckanext-files</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#example-implementation-of-custom-storage-adapter" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ckanext-files" class="md-header__button md-logo" aria-label="ckanext-files" data-md-component="logo">
      
  <img src="../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ckanext-files
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Example implementation of custom storage adapter
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256l137.3-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/DataShades/ckanext-files" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ckanext-files" class="md-nav__button md-logo" aria-label="ckanext-files" data-md-component="logo">
      
  <img src="../img/logo.png" alt="logo">

    </a>
    ckanext-files
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DataShades/ckanext-files" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Usage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/configure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configure the storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/use-in-code/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Usage in code
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/use-in-browser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Usage in browser
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/multi-storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi-storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/tracked-files/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tracked and untracked files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/permissions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Permissions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/ownership/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    File ownership
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/transfer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ownership transfer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/task-queue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task queue
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/capabilities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Capabilities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/multipart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multipart, resumable and signed uploads
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/js/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JavaScript utilities
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../upload-strategies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    File upload strategies
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Example implementation of custom storage adapter
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Example implementation of custom storage adapter
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    <span class="md-ellipsis">
      Storage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#settings" class="md-nav__link">
    <span class="md-ellipsis">
      Settings
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      Services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uploader" class="md-nav__link">
    <span class="md-ellipsis">
      Uploader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reader" class="md-nav__link">
    <span class="md-ellipsis">
      Reader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manager" class="md-nav__link">
    <span class="md-ellipsis">
      Manager
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../shared/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shared
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../validators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Validators
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../interfaces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interfaces
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../configuration/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/global/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Global configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../configuration/storage/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Storage configuration
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11_3" id="__nav_11_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_11_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11_3">
            <span class="md-nav__icon md-icon"></span>
            Storage configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis storage configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/fs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Filesystem storage configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/opendal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenDAL storage configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/libcloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache libcloud storage configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../migration/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Migration(experimental)
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_12" id="__nav_12_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Migration(experimental)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration/group/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Group/organization images
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration/user/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User avatars
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration/resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resource uploads
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    <span class="md-ellipsis">
      Storage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#settings" class="md-nav__link">
    <span class="md-ellipsis">
      Settings
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      Services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uploader" class="md-nav__link">
    <span class="md-ellipsis">
      Uploader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reader" class="md-nav__link">
    <span class="md-ellipsis">
      Reader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manager" class="md-nav__link">
    <span class="md-ellipsis">
      Manager
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="example-implementation-of-custom-storage-adapter">Example implementation of custom storage adapter</h1>
<p>Storage consist of the storage object that dispatches operation requests and 3
services that do the actual job: Reader, Uploader and Manager. To define a
custom storage, you need to extend the main storage class, describe storage
logic and register storage via <code>IFiles.files_get_storage_adapters</code>.</p>
<p>Let's implement DB storage. It will store files in SQL table using
SQLAlchemy. There will be just one requirement for the table: it must have
column for storing unique identifier of the file and another column for storing
content of the file as bytes.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For the sake of simplicity, our storage will work only with existing
tables. Create the table manually before we begin.</p>
</div>
<h2 id="storage">Storage</h2>
<p>First of all, we create an adapter that does nothing and register it in our
plugin.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>

<span class="kn">import</span> <span class="nn">ckan.plugins</span> <span class="k">as</span> <span class="nn">p</span>
<span class="kn">from</span> <span class="nn">ckan.model.types</span> <span class="kn">import</span> <span class="n">make_uuid</span>
<span class="kn">from</span> <span class="nn">ckanext.files</span> <span class="kn">import</span> <span class="n">shared</span>


<span class="k">class</span> <span class="nc">ExamplePlugin</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">SingletonPlugin</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">IFiles</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">files_get_storage_adapters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;example:db&quot;</span><span class="p">:</span> <span class="n">DbStorage</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">DbStorage</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Storage</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div>
<p>After installing and enabling your custom plugin, you can configure storage
with this adapter by adding a single new line to config file:</p>
<div class="highlight"><pre><span></span><code><span class="na">ckanext.files.storage.db.type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">files:db</span>
</code></pre></div>
<p>But if you check storage via <code>ckan files storages -v</code>, you'll see that it can't
do anything.</p>
<div class="highlight"><pre><span></span><code>ckan<span class="w"> </span>files<span class="w"> </span>storages<span class="w"> </span>-v

...<span class="w"> </span>db:<span class="w"> </span>example:db
...<span class="w">        </span>Supports:<span class="w"> </span>Capability.NONE
...<span class="w">        </span>Does<span class="w"> </span>not<span class="w"> </span>support:<span class="w"> </span>Capability.REMOVE<span class="p">|</span>STREAM<span class="p">|</span>CREATE<span class="p">|</span>...
</code></pre></div>
<h2 id="settings">Settings</h2>
<p>Before we start uploading files, let's make sure that storage has proper
configuration. As files will be stored in the DB table, we need the <em>name of
the table</em> and <em>DB connection string</em>. Let's assume that table already exists,
but we don't know which columns to use for files. So we need name of column for
content and for file's unique identifier. ckanext-files uses term <code>location</code>
instead of identifier, so we'll do the same in our implementation.</p>
<p>There are 4 required options in total:</p>
<ul>
<li><code>db_url</code>: DB connection string</li>
<li><code>table</code>: name of the table</li>
<li><code>location_column</code>: name of column for file's unique identifier</li>
<li><code>content_column</code>: name of column for file's content</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It's not mandatory, but is highly recommended that you declare config options
for the adapter. It can be done via <code>Storage.declare_config_options</code> class
method, which accepts <code>declaration</code> object and <code>key</code> namespace for storage
options.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DbStorage</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Storage</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">declare_config_options</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">declaration</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">declaration</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">db_url</span><span class="p">)</span><span class="o">.</span><span class="n">required</span><span class="p">()</span>
        <span class="n">declaration</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">required</span><span class="p">()</span>
        <span class="n">declaration</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">location_column</span><span class="p">)</span><span class="o">.</span><span class="n">required</span><span class="p">()</span>
        <span class="n">declaration</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">content_column</span><span class="p">)</span><span class="o">.</span><span class="n">required</span><span class="p">()</span>
</code></pre></div>
</div>
<p>And we probably want to initialize DB connection when storage is
initialized. For this we'll extend constructor, which must be defined as method
accepting keyword-only arguments:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DbStorage</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Storage</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="n">db_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_option</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;db_url&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_column</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">column</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensure_option</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;location_column&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_column</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_option</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;content_column&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">table</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ensure_option</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_column</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content_column</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>
</code></pre></div>
<p>You can notice that we are using <code>Storage.ensure_option</code> quite often. This
method returns the value of specified option from settings or raises an
exception.</p>
<p>The table definition and columns are saved as storage attributes, to simplify
building SQL queries in future.</p>
<h2 id="services">Services</h2>
<p>Now we are going to define classes for all 3 storage services and tell storage,
how to initialize these services.</p>
<p>There are 3 services: Reader, Uploader and Manager. Each of them initialized
via corresponding storage method: <code>make_reader</code>, <code>make_uploader</code> and
<code>make_manager</code>. And each of them accepts a single argument during creation, the
storage itself.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DbStorage</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Storage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">make_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DbReader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_uploader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DbUploader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DbManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DbReader</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">DbUploader</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Uploader</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">class</span> <span class="nc">DbManager</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div>
<h3 id="uploader">Uploader</h3>
<p>Our first target is Uploader service. It's responsible for file creation. For
the minimal implementation it needs <code>upload</code> method and <code>capabilities</code>
attribute which tells the storage, what exactly the Uploader can do.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DbUploader</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Uploader</span><span class="p">):</span>
    <span class="n">capabilities</span> <span class="o">=</span> <span class="n">shared</span><span class="o">.</span><span class="n">Capability</span><span class="o">.</span><span class="n">CREATE</span>

    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">upload</span><span class="p">:</span> <span class="n">shared</span><span class="o">.</span><span class="n">Upload</span><span class="p">,</span>
        <span class="n">extras</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shared</span><span class="o">.</span><span class="n">FileData</span><span class="p">:</span>
        <span class="o">...</span>
</code></pre></div>
<p><code>upload</code> receives the <code>location</code>(name) of the uploaded file; <code>upload</code> object
with file's content; and <code>extras</code> dictionary that contains any additional
arguments that can be passed to uploader. We are going to ignore <code>location</code> and
generate a unique UUID for every uploaded file instead of using user-defined
filename.</p>
<p>The goal is to write the file into DB and return <code>shared.FileData</code> that
contains location of the file in DB(value of <code>location_column</code>), size of the
file in bytes, MIMEtype of the file and hash of file content.</p>
<p>For location we'll just use <code>ckan.model.types.make_uuid</code> function. Size and
MIMEtype are already available as <code>upload.size</code> and <code>upload.content_type</code>.</p>
<p>The only problem is hash of the content. You can compute it in any way you
like, but there is a simple option if you have no preferences. <code>upload</code> has
<code>hashing_reader</code> method, which returns an iterable for file content. When you
read file through it, content hash is automatically computed and you can get it
using <code>get_hash</code> method of the reader.</p>
<p>Just make sure to read the whole file before checking the hash, because hash
computed using consumed content. I.e, if you just create the hashing reader,
but do not read a single byte from it, you'll receive the hash of empty
string. If you read just 1 byte, you'll receive the hash of this single byte,
etc.</p>
<p>The easiest option for you is to call <code>reader.read()</code> method to consume the
whole file and then call <code>reader.get_hash()</code> to receive the hash.</p>
<p>Here's the final implementation of DbUploader:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DbUploader</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Uploader</span><span class="p">):</span>
    <span class="n">capabilities</span> <span class="o">=</span> <span class="n">shared</span><span class="o">.</span><span class="n">Capability</span><span class="o">.</span><span class="n">CREATE</span>

    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">upload</span><span class="p">:</span> <span class="n">shared</span><span class="o">.</span><span class="n">Upload</span><span class="p">,</span> <span class="n">extras</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">shared</span><span class="o">.</span><span class="n">FileData</span><span class="p">:</span>
        <span class="n">uuid</span> <span class="o">=</span> <span class="n">make_uuid</span><span class="p">()</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">upload</span><span class="o">.</span><span class="n">hashing_reader</span><span class="p">()</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">location_column</span><span class="p">:</span> <span class="n">uuid</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">content_column</span><span class="p">:</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shared</span><span class="o">.</span><span class="n">FileData</span><span class="p">(</span>
            <span class="n">uuid</span><span class="p">,</span>
            <span class="n">upload</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="n">upload</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">get_hash</span><span class="p">()</span>
        <span class="p">)</span>
</code></pre></div>
<p>Now you can upload file into your new <code>db</code> storage:</p>
<div class="highlight"><pre><span></span><code>ckanapi<span class="w"> </span>action<span class="w"> </span>files_file_create<span class="w"> </span><span class="nv">storage</span><span class="o">=</span>db<span class="w"> </span><span class="nv">name</span><span class="o">=</span>hello.txt<span class="w"> </span>upload@&lt;<span class="o">(</span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;hello world&#39;</span><span class="o">)</span>

...<span class="o">{</span>
...<span class="w">  </span><span class="s2">&quot;atime&quot;</span>:<span class="w"> </span>null,
...<span class="w">  </span><span class="s2">&quot;content_type&quot;</span>:<span class="w"> </span><span class="s2">&quot;text/plain&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;ctime&quot;</span>:<span class="w"> </span><span class="s2">&quot;2024-06-17T13:48:52.121755+00:00&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;hash&quot;</span>:<span class="w"> </span><span class="s2">&quot;5eb63bbbe01eeed093cb22bb8f5acdc3&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;id&quot;</span>:<span class="w"> </span><span class="s2">&quot;bdfc0268-d36d-4f1b-8a03-2f2aaa21de24&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;location&quot;</span>:<span class="w"> </span><span class="s2">&quot;5a4472b3-cf38-4c58-81a6-4d4acb7b170e&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;mtime&quot;</span>:<span class="w"> </span>null,
...<span class="w">  </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;hello.txt&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;owner_id&quot;</span>:<span class="w"> </span><span class="s2">&quot;59ea0f6c-5c2f-438d-9d2e-e045be9a2beb&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;owner_type&quot;</span>:<span class="w"> </span><span class="s2">&quot;user&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;pinned&quot;</span>:<span class="w"> </span>false,
...<span class="w">  </span><span class="s2">&quot;size&quot;</span>:<span class="w"> </span><span class="m">11</span>,
...<span class="w">  </span><span class="s2">&quot;storage&quot;</span>:<span class="w"> </span><span class="s2">&quot;db&quot;</span>,
...<span class="w">  </span><span class="s2">&quot;storage_data&quot;</span>:<span class="w"> </span><span class="o">{}</span>
...<span class="o">}</span>
</code></pre></div>
<h3 id="reader">Reader</h3>
<p>File is created, but you cannot read it just yet. Try running <code>ckan files
stream</code> CLI command with file ID:</p>
<div class="highlight"><pre><span></span><code>ckan<span class="w"> </span>files<span class="w"> </span>stream<span class="w"> </span>bdfc0268-d36d-4f1b-8a03-2f2aaa21de24

...<span class="w"> </span>Operation<span class="w"> </span>stream<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>supported<span class="w"> </span>by<span class="w"> </span>db<span class="w"> </span>storage
...<span class="w"> </span>Aborted!
</code></pre></div>
<p>As expected, you have to write extra code.</p>
<p>Streaming, reading and generating links is a responsibility of Reader
service. We only need <code>stream</code> method for minimal implementation. This method
receives <code>shared.FileData</code> object(the same object as the one returned from
<code>Uploader.upload</code>) and <code>extras</code> containing all additional arguments passed by
the caller. The result is any iterable producing bytes.</p>
<p>We'll use <code>location</code> property of <code>shared.FileData</code> as a value for
<code>location_column</code> inside the table.</p>
<p>And don't forget to add <code>STREAM</code> capability to <code>Reader.capabilities</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DbReader</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Reader</span><span class="p">):</span>
    <span class="n">capabilities</span> <span class="o">=</span> <span class="n">shared</span><span class="o">.</span><span class="n">Capability</span><span class="o">.</span><span class="n">STREAM</span>

    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">shared</span><span class="o">.</span><span class="n">FileData</span><span class="p">,</span> <span class="n">extras</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sa</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">content_column</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">location_column</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">row</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The result may be confusing: we returning Row object from the stream
method. But our goal is to return <em>any</em> iterable that produces bytes. Row is
iterable(tuple-like). And it contains only one item - value of column with file
content, i.e, bytes. So it satisfies the requirements.</p>
</div>
<p>Now you can check content via CLI once again.</p>
<div class="highlight"><pre><span></span><code>ckan<span class="w"> </span>files<span class="w"> </span>stream<span class="w"> </span>bdfc0268-d36d-4f1b-8a03-2f2aaa21de24

...<span class="w"> </span>hello<span class="w"> </span>world
</code></pre></div>
<h3 id="manager">Manager</h3>
<p>Finally, we need to add file removal for the minimal implementation. And it
also nice to to have <code>SCAN</code> capability, as it shows all files currently
available in storage, so we add it as bonus. These operations handled by
Manager. We need <code>remove</code> and <code>scan</code> methods. Arguments are already familiar to
you. As for results:</p>
<ul>
<li><code>remove</code>: return <code>True</code> if file was successfully removed. Should return
  <code>False</code> if file does not exist, but it's allowed to return <code>True</code> as long as
  you are not checking the result.</li>
<li><code>scan</code>: return iterable with all file locations</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DbManager</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="n">storage</span><span class="p">:</span> <span class="n">DbStorage</span>
    <span class="n">capabilities</span> <span class="o">=</span> <span class="n">shared</span><span class="o">.</span><span class="n">Capability</span><span class="o">.</span><span class="n">SCAN</span> <span class="o">|</span> <span class="n">shared</span><span class="o">.</span><span class="n">Capability</span><span class="o">.</span><span class="n">REMOVE</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extras</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">location_column</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">shared</span><span class="o">.</span><span class="n">FileData</span> <span class="o">|</span> <span class="n">shared</span><span class="o">.</span><span class="n">MultipartData</span><span class="p">,</span>
        <span class="n">extras</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">location_column</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p>Now you can list the all the files in storage:
<div class="highlight"><pre><span></span><code>ckan<span class="w"> </span>files<span class="w"> </span>scan<span class="w"> </span>-s<span class="w"> </span>db
</code></pre></div></p>
<p>And remove file using ckanaapi and file ID</p>
<div class="highlight"><pre><span></span><code>ckanapi<span class="w"> </span>action<span class="w"> </span>files_file_delete<span class="w"> </span><span class="nv">id</span><span class="o">=</span>bdfc0268-d36d-4f1b-8a03-2f2aaa21de24
</code></pre></div>
<p>That's all you need for the basic storage. But check definition of base storage
and services to find details about other methods. And also check implementation
of other storages for additional ideas.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../upload-strategies/" class="md-footer__link md-footer__link--prev" aria-label="Previous: File upload strategies">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256l137.3-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                File upload strategies
              </div>
            </div>
          </a>
        
        
          
          <a href="../shared/" class="md-footer__link md-footer__link--next" aria-label="Next: Shared">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Shared
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.top", "content.code.copy", "content.code.select", "content.code.annotate", "navigation.footer", "navigation.indexes"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>